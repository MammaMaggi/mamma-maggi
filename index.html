<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mamma Maggi | Pedidos Online</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
:root{--bg:#111;--fg:#fff;--accent:#e63946;--card:#1a1a1a}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;line-height:1.5}
a{color:var(--accent);text-decoration:none}
button{font-family:inherit;border:none;cursor:pointer}
h1,h2,h3{font-family:'Staatliches',cursive;font-weight:400}

/* HEADER */
header{
  display:flex;align-items:center;justify-content:center;
  gap:.7rem;padding:1rem 1rem .5rem;position:relative;text-align:center
}
header h1{font-size:2.3rem;letter-spacing:2px}
#loginBtn{
  position:absolute;left:1rem;top:1rem;
  background:none;color:var(--fg);font-size:1rem
}
#cartBtn{
  position:absolute;right:1rem;top:1rem;
  width:42px;height:42px;border:2px solid var(--fg);border-radius:50%;
  background:none;color:var(--fg);display:flex;align-items:center;justify-content:center
}
#cartBtn span{font-size:.8rem}
#userInfo{font-size:.8rem;opacity:.8}

/* BANNER HORARIO */
#scheduleBanner{
  width:100%;
  background:#e63946;
  color:white;
  text-align:center;
  padding:8px 0;
  font-weight:700;
  font-size:.9rem;
}

/* NAV */
nav{
  text-align:center;
  margin-bottom:1rem;
}
nav a{
  margin:0 .6rem;
  font-size:.9rem;
  opacity:.9;
}
nav a:hover{opacity:1;text-decoration:underline}

/* LAYOUT PRINCIPAL: MEN√ö + CARRITO LATERAL */
.main-layout{
  max-width:1200px;
  margin:auto;
  padding:1.5rem 1rem 2rem;
  display:grid;
  grid-template-columns:minmax(0,2fr) 320px;
  gap:1.5rem;
  align-items:flex-start;
}
.main-layout section{
  max-width:100%;
  margin:0;
  padding:0;
}
section h2{text-align:center;font-size:2rem;margin-bottom:1.2rem}

/* CARDS MEN√ö (centrado visualmente) */
.menu-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1.5rem;
  justify-items:center;
}
.card{
  background:var(--card);border-radius:8px;
  padding:1rem;display:flex;flex-direction:column;gap:.6rem;
  width:100%;max-width:320px;
}
.price{font-weight:700}
.card button{
  margin-top:auto;padding:.6rem;border-radius:4px;
  background:var(--accent);color:#fff;font-weight:700
}

/* CARRITO LATERAL */
#sideCart{
  background:var(--card);
  border-radius:8px;
  padding:1rem;
  position:sticky;
  top:1rem;
  display:none; /* oculto hasta que haya productos */
}
#sideCart h3{
  margin-bottom:.6rem;
  font-size:1.2rem;
}
#sideCartItems{
  font-size:.9rem;
  display:flex;
  flex-direction:column;
  gap:.35rem;
  margin-bottom:.6rem;
}
.side-line{
  display:flex;
  justify-content:space-between;
  gap:.4rem;
}
.side-empty{
  opacity:.7;
  font-size:.85rem;
}
#sideTotal{
  text-align:right;
  font-weight:700;
  font-size:.95rem;
}

/* MODAL GEN√âRICO */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:opacity .3s
}
.modal.active{opacity:1;visibility:visible}
.box{
  background:var(--card);border-radius:8px;
  padding:1.4rem;width:90%;max-width:520px;
  max-height:90vh;overflow-y:auto;
  display:flex;flex-direction:column;gap:1rem
}
.close{
  align-self:flex-end;color:var(--fg);
  font-size:1.3rem;cursor:pointer;background:none
}
form{display:grid;gap:1rem}
input,select,textarea{
  padding:.7rem;border-radius:4px;
  border:1px solid #333;background:#222;color:var(--fg)
}
textarea{min-height:70px;resize:vertical}
.btn{
  padding:.8rem;border-radius:4px;
  background:var(--accent);color:#fff;font-weight:700
}

/* CARRITO EN MODAL */
.cart-item{
  display:flex;justify-content:space-between;
  align-items:center;gap:.4rem
}
.qty{
  display:flex;align-items:center;gap:.4rem
}
.qty button{
  width:24px;height:24px;border:1px solid var(--fg);
  background:none;color:var(--fg);
  border-radius:4px;font-weight:700
}
.summary{text-align:right;font-size:1.05rem;font-weight:700}
#map{height:220px;border-radius:6px;margin-top:.5rem;display:none}

/* SECCIONES EXTRA */
.static-section{
  max-width:960px;
  margin:0 auto 2rem;
  padding:0 1rem 2rem;
}
.static-section h2{
  text-align:center;
  font-size:1.9rem;
  margin-bottom:1rem;
}
.static-section p{
  margin-bottom:.6rem;
  font-size:.95rem;
  opacity:.9;
}

/* RECOMPENSAS PUNTOS */
.reward-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.5rem;
  font-size:.9rem;
  margin-top:.3rem;
}
.reward-item button{
  padding:.25rem .5rem;
  font-size:.8rem;
  border-radius:4px;
}

/* ADMIN PANEL */
#adminContent{
  margin-top:1rem;
}
.admin-order{
  border:1px solid #333;
  border-radius:6px;
  padding:.6rem .8rem;
  margin-bottom:.6rem;
  font-size:.85rem;
}
.admin-order-header{
  display:flex;
  justify-content:space-between;
  gap:.5rem;
  margin-bottom:.3rem;
  font-weight:700;
}
.admin-order-body{
  opacity:.9;
}

/* RESPONSIVE */
@media(max-width:800px){
  .main-layout{
    grid-template-columns:1fr;
  }
  #sideCart{
    position:static;
    margin-top:1rem;
  }
}
</style>
</head>
<body>
<header>
  <button id="loginBtn" title="Ingresar / Registrarse">üë§ Ingresar / Registrar</button>
  <h1>MAMMA MAGGI</h1>
  <div id="userInfo"></div>
  <button id="cartBtn">üõí <span id="cartCount">0</span></button>
</header>

<div id="scheduleBanner">
  üïí Horario: Mi√©‚ÄìS√°b 18:00‚Äì23:00 ‚Ä¢ Dom 12:00‚Äì16:00
</div>

<nav>
  <a href="#top">Pedidos</a>
  <a href="#nosotros">Nosotros</a>
  <a href="#club">Club Maggi</a>
  <a href="#eventos">Eventos</a>
  <a href="#contacto">Contacto</a>
  <a href="#admin">Admin</a>
</nav>

<a id="top"></a>
<div class="main-layout">
  <section>
    <h2>Nuestro Men√∫</h2>
    <div class="menu-grid" id="menuGrid"></div>
  </section>

  <aside id="sideCart">
    <h3>Tu pedido</h3>
    <div id="sideCartItems"></div>
    <p id="sideTotal">Subtotal: $0</p>
    <button class="btn" id="openCartFromSide" style="width:100%;margin-top:.5rem">
      Ver detalle y finalizar
    </button>
  </aside>
</div>

<!-- SECCI√ìN NOSOTROS -->
<section id="nosotros" class="static-section">
  <h2>Nosotros</h2>
  <p>Mamma Maggi nace en Temuco con la idea de hacer pizzas con cari√±o de casa, masa fermentada en fr√≠o y productos de calidad.</p>
  <p>Trabajamos con masas reposadas, buena mozzarella y recetas pensadas para que cada pizza realmente valga la pena.</p>
</section>

<!-- SECCI√ìN CLUB MAGGI -->
<section id="club" class="static-section">
  <h2>Club Maggi</h2>
  <p>Por cada compra acumulas puntos en tu cuenta. Luego, puedes canjearlos por productos especiales del men√∫.</p>
  <p>Ejemplo: Tiramis√∫ o Palitos de Ajo / Queso, seg√∫n los puntos que tengas acumulados.</p>
</section>

<!-- SECCI√ìN EVENTOS -->
<section id="eventos" class="static-section">
  <h2>Eventos y Catering</h2>
  <p>¬øTienes cumplea√±os, reuni√≥n con amigos o evento de empresa? Escr√≠benos y armamos un plan de pizzas para tu grupo.</p>
  <p>Puedes pedir por WhatsApp indicando fecha, horario estimado, cantidad de personas y sector en Temuco.</p>
</section>

<!-- SECCI√ìN CONTACTO -->
<section id="contacto" class="static-section">
  <h2>Contacto</h2>
  <p>üìç Sector L√©rida con Javiera Carrera, Temuco.</p>
  <p>‚è∞ Horario: Mi√©rcoles a S√°bado 18:00‚Äì23:00 y Domingo 12:00‚Äì16:00 hrs.</p>
  <p>üì± WhatsApp: <a href="https://wa.me/56949486579" target="_blank">+56 9 4948 6579</a></p>
  <p>üì∏ Instagram: <a href="https://www.instagram.com/mamma.maggi" target="_blank">@mamma.maggi</a></p>
</section>

<!-- PANEL ADMIN -->
<section id="admin" class="static-section">
  <h2>Panel Admin</h2>
  <p style="font-size:.9rem;opacity:.8;">Ingresa la clave de administrador para ver el flujo de pedidos.</p>
  <div id="adminLogin">
    <input type="password" id="adminPass" placeholder="Clave admin" />
    <button class="btn" id="adminEnter" style="margin-top:.4rem;">Entrar</button>
  </div>
  <div id="adminContent" style="display:none">
    <button class="btn" id="refreshOrders" style="margin-bottom:.7rem;">Actualizar pedidos</button>
    <div id="ordersList"></div>
  </div>
</section>

<!-- Auth Modal -->
<div class="modal" id="authModal"><div class="box">
  <button class="close" id="closeAuth">‚úï</button>
  <h2 id="authTitle">Inicia Sesi√≥n</h2>
  <form id="authForm">
    <input type="email" id="email" placeholder="Correo" required />
    <input type="password" id="pass" placeholder="Contrase√±a" required />
    <!-- Confirmar contrase√±a SOLO para registro -->
    <input type="password" id="pass2" placeholder="Confirmar contrase√±a" style="display:none" />

    <div id="extra" style="display:none">
      <input id="name" placeholder="Nombre" required />
      <input id="last" placeholder="Apellido" required />
      <input 
        id="phone" 
        placeholder="Tel√©fono (+569...)" 
        required
        pattern="^\+?56?\s?9?\d{8}$"
        title="Ingresa un n√∫mero chileno v√°lido, ejemplo: +56964400283"
      />
      <input id="addr" placeholder="Direcci√≥n (Temuco)" required />
      <button type="button" class="btn" id="geoBtn">Confirmar direcci√≥n</button>
      <p id="distText" style="text-align:center"></p>
      <div id="map"></div>
    </div>

    <button class="btn" id="authSubmit" type="submit">Entrar</button>
    <p id="toggleAuth" style="text-align:center;cursor:pointer;margin-top:.5px">
      ¬øNo tienes cuenta? Reg√≠strate
    </p>
  </form>
</div></div>

<!-- Cart Modal -->
<div class="modal" id="cartModal"><div class="box">
  <button class="close" id="closeCart">‚úï</button>
  <h2>Tu Pedido</h2>
  <div id="cartItems"></div>

  <div>
    <label><input type="radio" name="delType" value="pickup" checked /> Retiro</label>
    <label style="margin-left:.7rem;"><input type="radio" name="delType" value="delivery"/> Delivery</label>
  </div>

  <!-- Detalle de delivery (direcci√≥n a cobrar por distancia) -->
  <div id="deliveryDetails" style="display:none;margin-top:.4rem">
    <input id="delAddr" placeholder="Direcci√≥n de entrega (Temuco)" />
    <button type="button" class="btn" id="delGeoBtn" style="margin-top:.4rem">Confirmar direcci√≥n delivery</button>
    <p id="delDistText" style="font-size:.85rem;text-align:center;margin-top:.25rem"></p>
  </div>

  <!-- CU√ÅNDO QUIERES EL PEDIDO -->
  <div style="margin-top:.7rem">
    <label><strong>¬øPara cu√°ndo?</strong></label><br/>
    <label><input type="radio" name="whenType" value="now" checked> Lo antes posible (hoy)</label>
    <label style="margin-left:.7rem;"><input type="radio" name="whenType" value="later"> Programar</label>
    <div id="scheduleFields" style="display:none;margin-top:.4rem;gap:.4rem;flex-wrap:wrap;">
      <select id="schedDate"></select>
      <select id="schedTime"></select>
    </div>
    <small id="scheduleHint" style="font-size:.8rem;opacity:.8;"></small>
  </div>

  <div style="margin-top:.7rem">
    <label>C√≥digo</label>
    <div style="display:flex;gap:.4rem;margin-top:.3rem">
      <input id="coupon" style="flex:1"/>
      <button class="btn" id="couponBtn" style="padding:.5rem .8rem">Aplicar</button>
    </div>
    <small id="couponMsg"></small>
  </div>

  <!-- CLUB MAGGI / PUNTOS -->
  <div id="ptsBox" style="display:none;margin-top:.7rem">
    <p>Tienes <span id="pts">0</span> puntos Club Maggi.</p>
    <div id="rewardsList"></div>
  </div>

  <!-- Comentario antes de finalizar -->
  <div style="margin-top:.7rem">
    <label for="orderComment">Comentario para tu pedido (opcional)</label>
    <textarea id="orderComment" placeholder="Ej: sin cebolla, tocar timbre, dejar en conserjer√≠a, etc."></textarea>
  </div>

  <p class="summary">Subtotal: $<span id="sub">0</span></p>
  <p class="summary" id="delRow" style="display:none">Delivery (<span id="km">0</span> km): $<span id="del">0</span></p>
  <p class="summary" id="discRow" style="display:none">Descuento: ‚Äì$<span id="disc">0</span></p>
  <p class="summary">Total: $<span id="tot">0</span></p>
  <a class="btn" id="checkout" href="#">Finalizar por WhatsApp</a>
</div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===========================
//  FIREBASE INIT (FIRESTORE)
// ===========================
let db = null;
const firebaseConfig = {
  apiKey: "AIzaSyCd8jNdpZjHJkX-Ft0I6RplS-46vfjbYeU",
  authDomain: "mamma-maggi.firebaseapp.com",
  projectId: "mamma-maggi",
  storageBucket: "mamma-maggi.firebasestorage.app",
  messagingSenderId: "148248596670",
  appId: "1:148248596670:web:91dc5b239ce6b9a9130eef",
  measurementId: "G-L8ZT1KN1YC"
};

try{
  if(typeof firebase !== "undefined"){
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase inicializado");
  }else{
    console.warn("Firebase no est√° disponible");
  }
}catch(err){
  console.error("Error iniciando Firebase:", err);
  db = null;
}

// ===========================
//  DATOS Y CONSTANTES
// ===========================
const MENU=[
  {id:1,name:'Margarita',desc:'Un cl√°sico de las pizzas, una combi simple pero perfecta, salsa de tomate, mozzarella, albahaca y parmesano.',price:9990},
  {id:2,name:'Pepperoni',desc:'Otro cl√°sico infaltable, salsa tomate, mozzarella, pepperoni.',price:10500},
  {id:3,name:'Not Fugazza',desc:'Salsa de tomate, mozzarella, aceitunas y cebolla.',price:10990},
  {id:4,name:'Napolitana',desc:'Salsa de tomate, mozzarella, jam√≥n, tomate cherry y or√©gano.',price:11500},
  {id:5,name:'Hawaiana',desc:'Salsa de tomate, mozzarella, jam√≥n y pi√±a.',price:11500},
  {id:6,name:'Vegetariana',desc:'Salsa de tomate, mozzarella, aceitunas, chapi√±ones, cebolla morada y piment√≥n.',price:11990},
  {id:7,name:'Pesto Cherry',desc:'Salsa de tomate, mozzarella, tomate cherry y pesto.',price:11990},
  {id:8,name:'Pollo BBQ',desc:'Salsa BBQ, mozzarella, pollo, tocino, cebolla morada.',price:12500},
  {id:9,name:'Capi',desc:'Salsa de tomate, mozzarella, pera y queso azul.',price:12500},
  {id:10,name:'Pitu',desc:'Salsa de tomate, mozzarella, jam√≥n serrano, r√∫cula y parmesano.',price:12990},
  {id:11,name:'Bernarda',desc:'Salsa de tomate, mozzarella, queso azul, nueces, miel, ricotta y albahaca.',price:10990},
  {id:12,name:'Bacon No Bacon',desc:'Salsa de tomate, mozzarella, proteina de soja sabor tocino y cebolla.',price:10990},
  {id:13,name:'Mare Verde',desc:'Salsa de tomate, mozzarella, salm√≥n ahumado, r√∫cula y parmesano.',price:10990},
  {id:14,name:'Gamberetti',desc:'Salsa de tomate, mozzarella, camarones salteados en mantequilla de ajo, perejil y lim√≥n.',price:10990},
  {id:15,name:'Sweet Cherry',desc:'Salsa de tomate, mozzarella, tomates cherry confitados, aceitunas y albahaca.',price:10990},
  {id:16,name:'Tiramis√∫',desc:'Postre cl√°sico italiano.',price:4990},
  {id:17,name:'Palitos de ajo',desc:'Palitos con salsa de ajo y parmesano.',price:4500},
  {id:18,name:'Palitos de queso',desc:'Palitos de queso con mozzarella y or√©gano.',price:4990}
];

const ORIGIN=[-38.731229, -72.626507];
const CODE={MAGGI10:.1};
const PHONE='56949486579';
const RATE=.001; // regla puntos: 1 punto por cada $1000 aprox
const FEE=km=>Math.ceil(km)*1000; // 1 km = $1000
const $=q=>document.querySelector(q),fmt=n=>n.toLocaleString('es-CL');

// Recompensas canjeables con puntos (usa IDs de MENU)
const REWARDS=[
  {id:16,pts:10,label:'Canjear Tiramis√∫ (10 pts)'},
  {id:17,pts:8,label:'Canjear Palitos de Ajo (8 pts)'},
  {id:18,pts:8,label:'Canjear Palitos de Queso (8 pts)'},
];

const ADMIN_PASS = "mamma2025";

/* Storage local para usuarios */
const users=JSON.parse(localStorage.getItem('users')||'{}');
function saveUsers(){localStorage.setItem('users',JSON.stringify(users));}

/* Points release check */
function releasePoints(u){
  if(u.pending&&Date.now()-u.pendingAt>=300000){
    u.points=(u.points||0)+u.pending;
    u.pending=0;
    saveUsers();
  }
}

/* Normalizar tel√©fono (deja solo d√≠gitos) */
function normalizePhone(phone){
  return phone.replace(/\D/g,'');
}

/* Estado */
let user=null,
    cart={},
    cartRewards={},
    delType='pickup',
    code=null,
    whenType='now',
    orderDelivery=null;

/* Render men√∫ */
MENU.forEach(i=>{
  const c=document.createElement('div');
  c.className='card';
  c.innerHTML=`
    <h3>${i.name}</h3>
    <p>${i.desc}</p>
    <span class='price'>$${fmt(i.price)}</span>
    <button class='btn' data-id='${i.id}'>Agregar</button>`;
  $('#menuGrid').appendChild(c);
});

/* Agregar al carrito */
$('#menuGrid').onclick=e=>{
  if(e.target.dataset.id){
    const id=+e.target.dataset.id;
    cart[id]=(cart[id]||0)+1;
    updateCount();
    renderCart();
  }
};

function updateCount(){
  $('#cartCount').textContent=Object.values(cart).reduce((a,b)=>a+b,0);
}

/* Auth modal */
const authM=$('#authModal');
const authForm=$('#authForm');

$('#loginBtn').onclick=()=>authM.classList.add('active');
$('#closeAuth').onclick=()=>closeAuthModal();

function closeAuthModal(){
  authM.classList.remove('active');
  authForm.reset();
  loginMode=true;
  $('#authTitle').textContent='Inicia Sesi√≥n';
  $('#authSubmit').textContent='Entrar';
  $('#extra').style.display='none';
  $('#pass2').style.display='none';
}

let loginMode=true;
$('#toggleAuth').onclick=()=>{
  loginMode=!loginMode;
  $('#authTitle').textContent=loginMode?'Inicia Sesi√≥n':'Crea tu Cuenta';
  $('#authSubmit').textContent=loginMode?'Entrar':'Registrar';
  $('#extra').style.display=loginMode?'none':'block';
  $('#pass2').style.display=loginMode?'none':'block';
};

/* Geocode registro (direcci√≥n principal) */
function toRad(d){return d*Math.PI/180;}
const dist=(a,b,c,d)=>{
  const R=6371;
  const dLat=toRad(c-a),dLon=toRad(d-b);
  const s=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
};

$('#geoBtn').onclick=async()=>{
  const addr=$('#addr').value.trim();
  if(!addr)return alert('Ingresa direcci√≥n');
  const d=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr+', Temuco, Chile')}`).then(r=>r.json());
  if(!d[0])return alert('No encontrada');
  const {lat,lon}=d[0];
  const km=Math.round(dist(ORIGIN[0],ORIGIN[1],+lat,+lon)*10)/10;
  const fee=FEE(km);
  $('#distText').textContent=`Referencia: est√°s a ${km} km del local.`;
  $('#map').style.display='block';
  if(!window._map){
    window._map=L.map('map').setView([lat,lon],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(window._map);
  }
  window._map.setView([lat,lon],13);
  if(window._mk)window._map.removeLayer(window._mk);
  window._mk=L.marker([lat,lon]).addTo(window._map);
  if (!user) user = {};
  Object.assign(user, { lat: +lat, lng: +lon, km, fee, address: addr });
};

/* Actualizar UI usuario */
function updateUserUI(){
  if(user){
    $('#userInfo').textContent=`Hola, ${user.nombre} (${user.points||0} pts)`;
    $('#pts').textContent=user.points||0;
    $('#ptsBox').style.display='block';
    renderRewards();
  }else{
    $('#userInfo').textContent='';
    $('#ptsBox').style.display='none';
    $('#rewardsList').innerHTML='';
  }
}

/* Login / Registro */
$('#authForm').onsubmit=e=>{
  e.preventDefault();
  const email=$('#email').value.trim().toLowerCase();
  const pass=$('#pass').value;
  const pass2=$('#pass2').value;

  if(loginMode){
    // LOGIN
    if(!users[email]||users[email].pass!==pass){
      alert('Credenciales inv√°lidas');
      return;
    }
    user={...users[email]};
    releasePoints(user);
  }else{
    // REGISTRO
    if(pass!==pass2){
      alert('Las contrase√±as no coinciden');
      return;
    }
    if(!user||!user.address){
      alert('Confirma tu direcci√≥n principal antes de registrarte.');
      return;
    }
    user={
      ...user,
      email,
      pass,
      nombre:$('#name').value.trim(),
      apellido:$('#last').value.trim(),
      phone:normalizePhone($('#phone').value),
      points:0,
      pending:0
    };
    users[email]=user;
    saveUsers();
  }

  updateUserUI();
  closeAuthModal();

  if($('#cartModal').classList.contains('wait-login')){
    $('#cartModal').classList.remove('wait-login');
    calc();
    $('#cartModal').classList.add('active');
  }
};

/* Cart modal */
$('#cartBtn').onclick=()=>{
  renderCart();
  $('#cartModal').classList.add('active');
};
$('#closeCart').onclick=()=>$('#cartModal').classList.remove('active');

/* bot√≥n lateral "ver detalle" */
$('#openCartFromSide').onclick=()=>{
  renderCart();
  $('#cartModal').classList.add('active');
};

/* Cambios en cantidades dentro del modal */
$('#cartItems').onclick=e=>{
  if(e.target.closest('.qty')){
    const id=+e.target.closest('.qty').dataset.id;
    if(e.target.classList.contains('inc'))cart[id]++;
    if(e.target.classList.contains('dec'))cart[id]=Math.max(0,cart[id]-1);
    if(!cart[id])delete cart[id];
    updateCount();
    renderCart();
  }
};

function renderCart(){
  const w=$('#cartItems');
  const s=$('#sideCartItems');
  w.innerHTML='';
  s.innerHTML='';

  let sub=0;
  for(const id in cart){
    const it=MENU.find(m=>m.id==id),
          q = cart[id];

    w.innerHTML+=`
      <div class='cart-item'>
        <span>${it.name}</span>
        <div class='qty' data-id='${id}'>
          <button class='dec'>-</button>
          <span>${q}</span>
          <button class='inc'>+</button>
        </div>
        <span>$${fmt(it.price*q)}</span>
      </div>`;

    s.innerHTML+=`
      <div class="side-line">
        <span>${q} x ${it.name}</span>
        <span>$${fmt(it.price*q)}</span>
      </div>`;

    sub+=it.price*q;
  }

  for(const rid in cartRewards){
    const it=MENU.find(m=>m.id==rid),
          q=cartRewards[rid];
    if(!it) continue;

    w.innerHTML+=`
      <div class='cart-item'>
        <span>${it.name} (canje puntos)</span>
        <span>${q} x</span>
        <span>$0</span>
      </div>`;

    s.innerHTML+=`
      <div class="side-line">
        <span>${q} x ${it.name} (canje)</span>
        <span>$0</span>
      </div>`;
  }

  if(!Object.keys(cart).length && !Object.keys(cartRewards).length){
    s.innerHTML='';
    $('#sideCart').style.display='none';
  }else{
    $('#sideCart').style.display='block';
  }

  $('#sub').textContent=fmt(sub);
  $('#sideTotal').textContent='Subtotal: $'+fmt(sub);
  calc();
}

/* Delivery / cupones */
document.querySelectorAll('input[name="delType"]').forEach(r=>r.onchange=e=>{
  delType=e.target.value;
  if(delType==='delivery'){
    $('#deliveryDetails').style.display='block';
  }else{
    $('#deliveryDetails').style.display='none';
    $('#delRow').style.display='none';
    orderDelivery=null;
    $('#delDistText').textContent='';
  }
  calc();
});

$('#couponBtn').onclick=e=>{
  e.preventDefault();
  const c=$('#coupon').value.trim().toUpperCase();
  code=CODE[c]?c:null;
  $('#couponMsg').textContent=code?'Aplicado ‚úì':'Inv√°lido';
  calc();
};

/* Geocode DELIVERY */
$('#delGeoBtn').onclick=async()=>{
  const addr=$('#delAddr').value.trim();
  if(!addr)return alert('Ingresa direcci√≥n de entrega');
  const d=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr+', Temuco, Chile')}`).then(r=>r.json());
  if(!d[0])return alert('No encontrada');
  const {lat,lon}=d[0];
  const km=Math.round(dist(ORIGIN[0],ORIGIN[1],+lat,+lon)*10)/10;
  const fee=FEE(km);
  orderDelivery={address:addr,lat:+lat,lng:+lon,km,fee};
  $('#delDistText').textContent=`Delivery a ${km} km ‚Ä¢ Costo: $${fmt(fee)}`;
  calc();
};

/* CU√ÅNDO QUIERES EL PEDIDO */
document.querySelectorAll('input[name="whenType"]').forEach(r=>r.onchange=e=>{
  whenType=e.target.value;
  if(whenType==='later'){
    $('#scheduleFields').style.display='flex';
    buildScheduleOptions();
  }else{
    $('#scheduleFields').style.display='none';
    $('#scheduleHint').textContent='';
  }
});

/* Ventanas de horario */
function getOpenWindowsForDay(dayIdx){
  if(dayIdx===0) return [{start:12,end:16}];
  if(dayIdx>=3 && dayIdx<=6) return [{start:18,end:23}];
  return [];
}

/* Construir opciones de programaci√≥n (7 d√≠as) */
function buildScheduleOptions(){
  const dateSel = $('#schedDate');
  const timeSel = $('#schedTime');
  dateSel.innerHTML='';
  timeSel.innerHTML='';

  const now = new Date();

  for(let i=0;i<7;i++){
    const d = new Date();
    d.setDate(now.getDate()+i);
    const windows = getOpenWindowsForDay(d.getDay());
    if(!windows.length) continue;

    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const value = `${yyyy}-${mm}-${dd}`;
    const label = d.toLocaleDateString('es-CL',{weekday:'short', day:'numeric', month:'short'});

    const opt=document.createElement('option');
    opt.value=value;
    opt.textContent=label;
    dateSel.appendChild(opt);
  }

  if(!dateSel.options.length){
    dateSel.innerHTML='<option value="">Sin d√≠as disponibles</option>';
    timeSel.innerHTML='<option value="">Sin horarios</option>';
    $('#scheduleHint').textContent='No hay d√≠as disponibles para programar.';
    return;
  }

  dateSel.onchange = rebuildTimeOptions;
  rebuildTimeOptions();
}

function rebuildTimeOptions(){
  const dateSel = $('#schedDate');
  const timeSel = $('#schedTime');
  const val = dateSel.value;
  timeSel.innerHTML='';

  if(!val){
    const o=document.createElement('option');
    o.value='';
    o.textContent='Selecciona fecha';
    timeSel.appendChild(o);
    return;
  }

  const [y,m,d]=val.split('-').map(Number);
  const dtBase = new Date(y,m-1,d);
  const windows = getOpenWindowsForDay(dtBase.getDay());
  if(!windows.length){
    const o=document.createElement('option');
    o.value='';
    o.textContent='Sin horarios';
    timeSel.appendChild(o);
    return;
  }

  const now = new Date();
  const minWaitMs = 25*60*1000;
  const minDate = new Date(now.getTime()+minWaitMs);

  windows.forEach(win=>{
    for(let h=win.start; h<win.end; h++){
      for(let min=0; min<60; min+=15){
        const slot = new Date(y,m-1,d,h,min,0);
        const value = `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
        const o=document.createElement('option');
        o.value=value;

        let label = `${value}`;
        if(slot < minDate && slot.toDateString()===now.toDateString()){
          o.disabled=true;
          label += ' (no disponible)';
        }
        o.textContent=label;
        timeSel.appendChild(o);
      }
    }
  });

  const firstEnabled = Array.from(timeSel.options).find(o=>!o.disabled && o.value);
  if(firstEnabled) timeSel.value = firstEnabled.value;

  $('#scheduleHint').textContent='Solo horarios en horario de atenci√≥n. M√≠nimo 25 min de anticipaci√≥n.';
}

/* Horario v√°lido */
function isInSchedule(dateObj){
  const day=dateObj.getDay();
  const hour=dateObj.getHours();
  const min=dateObj.getMinutes();

  if(day===0){
    return hour>=12 && (hour<16 || (hour===16 && min===0));
  }
  if(day>=3 && day<=6){
    return hour>=18 && (hour<23 || (hour===23 && min===0));
  }
  return false;
}

/* Abierto ahora */
function isOpenNow(){
  const now=new Date();
  return isInSchedule(now);
}

/* Puntos / recompensas */
function renderRewards(){
  const box = $('#rewardsList');
  box.innerHTML='';
  if(!user) return;

  REWARDS.forEach(r=>{
    const it = MENU.find(m=>m.id===r.id);
    if(!it) return;
    const can = (user.points||0) >= r.pts;
    box.innerHTML+=`
      <div class="reward-item">
        <span>${r.label}</span>
        <button class="btn" data-rid="${r.id}" ${can?'':'disabled'}>
          ${can?'Canjear':'No alcanza'}
        </button>
      </div>`;
  });
}

$('#rewardsList').onclick=e=>{
  const btn=e.target.closest('button[data-rid]');
  if(!btn || !user) return;
  const rid=+btn.dataset.rid;
  const reward=REWARDS.find(r=>r.id===rid);
  if(!reward) return;
  if((user.points||0) < reward.pts) return;

  user.points = (user.points||0) - reward.pts;
  users[user.email]=user;
  saveUsers();
  cartRewards[rid]=(cartRewards[rid]||0)+1;

  updateUserUI();
  renderCart();
};

/* C√°lculo totales */
function calc(){
  const sub=parseInt($('#sub').textContent.replace(/\./g,''))||0;
  let del=0,km=0;

  if(delType==='delivery' && orderDelivery){
    del=orderDelivery.fee;
    km=orderDelivery.km;
  }

  $('#delRow').style.display=(delType==='delivery' && orderDelivery)?'block':'none';
  $('#del').textContent=fmt(del);
  $('#km').textContent=km;

  const disc=code?Math.round(sub*CODE[code]):0;
  $('#discRow').style.display=disc?'block':'none';
  $('#disc').textContent=fmt(disc);

  const tot=sub+del-disc;
  $('#tot').textContent=fmt(tot);
}

/* CHECKOUT: WhatsApp + Firestore */
$('#checkout').onclick = async e => {
  const total=parseInt($('#tot').textContent.replace(/\./g,''))||0;

  if (!user){
    e.preventDefault();
    $('#cartModal').classList.remove('active');
    $('#cartModal').classList.add('wait-login');
    authM.classList.add('active');
    return;
  }
  if (total <= 0){
    e.preventDefault();
    alert("Tu pedido no tiene productos.");
    return;
  }

  if(delType==='delivery'){
    if(!orderDelivery || !orderDelivery.address){
      e.preventDefault();
      alert("Debes confirmar la direcci√≥n de entrega.");
      return;
    }
  }

  const sub = parseInt($('#sub').textContent.replace(/\./g,''))||0;
  const delCost = (delType==='delivery' && orderDelivery)? orderDelivery.fee : 0;

  const now = new Date();
  const minWaitMs = 25*60*1000;
  const minDate = new Date(now.getTime() + minWaitMs);
  let scheduledDate = null;

  if(whenType==='later'){
    const dVal = $('#schedDate').value;
    const tVal = $('#schedTime').value;

    if (!dVal || !tVal){
      e.preventDefault();
      alert("Selecciona fecha y hora para programar tu pedido.");
      return;
    }

    const [y,m,d] = dVal.split('-').map(Number);
    const [hh,mm] = tVal.split(':').map(Number);
    const dt = new Date(y,m-1,d,hh,mm,0);
    scheduledDate = dt;

    if (dt < minDate){
      e.preventDefault();
      alert("El pedido debe programarse al menos 25 minutos m√°s tarde.");
      return;
    }
    if (!isInSchedule(dt)){
      e.preventDefault();
      alert("La hora seleccionada est√° fuera del horario de atenci√≥n.\nMi√©‚ÄìS√°b 18:00‚Äì23:00\nDom 12:00‚Äì16:00");
      return;
    }
  }else{
    if(!isOpenNow()){
      e.preventDefault();
      alert("Estamos cerrados ahora.\nMi√©‚ÄìS√°b 18:00‚Äì23:00\nDom 12:00‚Äì16:00");
      return;
    }
  }

  const comment = ($('#orderComment').value || '').trim();

  // Puntos
  const earn=Math.floor(total*RATE);
  user.pending=earn;
  user.pendingAt=Date.now();
  users[user.email]=user;
  saveUsers();

  // Guardar pedido en Firestore (si hay db)
  const items = Object.entries(cart).map(([id,q])=>{
    const it = MENU.find(m=>m.id==id);
    return {
      id:+id,
      name:it?.name || '',
      qty:q,
      unitPrice:it?.price || 0,
      lineTotal:(it?.price || 0)*q
    };
  });

  const rewardsItems = Object.entries(cartRewards).map(([id,q])=>{
    const it = MENU.find(m=>m.id==id);
    return {
      id:+id,
      name:it?.name || '',
      qty:q,
      reward:true
    };
  });

  const orderData = {
    items,
    rewards:rewardsItems,
    subtotal:sub,
    deliveryCost:delCost,
    total,
    deliveryType:delType,
    deliveryAddress:delType==='delivery' && orderDelivery ? orderDelivery.address : null,
    deliveryKm:delType==='delivery' && orderDelivery ? orderDelivery.km : null,
    comment,
    whenType,
    scheduledAt: scheduledDate && db ? firebase.firestore.Timestamp.fromDate(scheduledDate) : null,
    createdAt: db ? firebase.firestore.FieldValue.serverTimestamp() : null,
    user:{
      email:user.email,
      nombre:user.nombre,
      apellido:user.apellido,
      phone:user.phone,
      address:user.address || null
    },
    status:'pendiente',
    source:'web'
  };

  if(db){
    try{
      await db.collection('orders').add(orderData);
      console.log("Pedido guardado en Firestore");
    }catch(err){
      console.error("Error guardando pedido:", err);
    }
  }else{
    console.warn("No se guarda en Firestore (db nula)");
  }

  // Mensaje WhatsApp en texto normal
  let msg = "Hola Mamma Maggi!\nPedido:\n";

  for(const id in cart){
    const it = MENU.find(m=>m.id==id);
    msg += `${cart[id]} x ${it.name}\n`;
  }
  for(const rid in cartRewards){
    const it = MENU.find(m=>m.id==rid);
    msg += `${cartRewards[rid]} x ${it.name} (canje)\n`;
  }

  msg += `\nTotal: $${fmt(total)}\n`;

  if(whenType==='later' && scheduledDate){
    const dVal = $('#schedDate').value;
    const tVal = $('#schedTime').value;
    msg += `Para: ${dVal} ${tVal}\n`;
  }else{
    msg += `Para: Lo antes posible (hoy)\n`;
  }

  if(delType==='delivery'){
    msg += `Modalidad: Delivery\n`;
    msg += `Entrega: ${orderDelivery?.address || ''}\n`;
  }else{
    msg += `Modalidad: Retiro en local\n`;
  }

  msg += `Tiempo de espera m√≠nimo: 25 minutos\n`;
  if(comment) msg += `Comentario: ${comment}\n`;
  msg += `Tel√©fono cliente: ${user.phone || ''}`;

  const waURL = `https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`;
  e.currentTarget.href = waURL;
};

/* PANEL ADMIN */
$('#adminEnter').onclick = ()=>{
  const val = $('#adminPass').value;
  if(val === ADMIN_PASS){
    $('#adminLogin').style.display='none';
    $('#adminContent').style.display='block';
    loadOrders();
  }else{
    alert('Clave incorrecta');
  }
};

$('#refreshOrders').onclick = loadOrders;

function loadOrders(){
  const container = $('#ordersList');
  if(!db){
    container.innerHTML='<p style="color:#f88;">Firestore no est√° disponible.</p>';
    return;
  }
  container.innerHTML='Cargando pedidos...';

  db.collection('orders')
    .orderBy('createdAt','desc')
    .limit(50)
    .get()
    .then(snap=>{
      if(snap.empty){
        container.innerHTML='<p style="font-size:.9rem;opacity:.8;">No hay pedidos registrados.</p>';
        return;
      }
      container.innerHTML='';
      snap.forEach(doc=>{
        const data = doc.data();
        const created = data.createdAt ? data.createdAt.toDate() : null;
        const fecha = created ? created.toLocaleString('es-CL') : '---';

        const div = document.createElement('div');
        div.className='admin-order';
        div.innerHTML=`
          <div class="admin-order-header">
            <span>${data.user?.nombre || 'Cliente'}</span>
            <span>${fecha}</span>
          </div>
          <div class="admin-order-body">
            <p><strong>Total:</strong> $${fmt(data.total || 0)}</p>
            <p><strong>Modalidad:</strong> ${data.deliveryType==='delivery'?'Delivery':'Retiro'}</p>
            ${data.deliveryAddress ? `<p><strong>Entrega:</strong> ${data.deliveryAddress}</p>`:''}
            <p><strong>Estado:</strong> ${data.status || 'pendiente'}</p>
            <p><strong>Items:</strong></p>
            <ul style="margin-left:1rem;">
              ${ (data.items||[]).map(it=>`<li>${it.qty} x ${it.name}</li>`).join('') }
              ${ (data.rewards||[]).map(it=>`<li>${it.qty} x ${it.name} (canje)</li>`).join('') }
            </ul>
          </div>
        `;
        container.appendChild(div);
      });
    })
    .catch(err=>{
      console.error(err);
      container.innerHTML='<p style="color:#f88;">Error cargando pedidos.</p>';
    });
}

/* INICIO */
updateUserUI();
</script>
</body>
</html>

</script>
</body>
</html>

