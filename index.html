<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mamma Maggi | Pedidos Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#111;
      --fg:#fff;
      --accent:#e63946;
      --card:#1a1a1a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:var(--fg);
      min-height:100vh;
      line-height:1.5;
    }
    a{color:var(--accent);text-decoration:none}
    button{font-family:inherit;border:none;cursor:pointer}
    h1,h2,h3{font-family:'Staatliches',cursive;font-weight:400}

    header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.75rem;
      padding:1rem 1.2rem;
      position:relative;
      text-align:center;
      border-bottom:1px solid #222;
    }
    header h1{
      font-size:2.4rem;
      letter-spacing:2px;
    }
    #userInfo{
      position:absolute;
      left:1.2rem;
      top:50%;
      transform:translateY(-50%);
      font-size:.85rem;
      opacity:.9;
      max-width:40%;
    }
    #loginBtn{
      position:absolute;
      right:1.2rem;
      top:50%;
      transform:translateY(-50%);
      background:none;
      color:var(--fg);
      font-size:.9rem;
      padding:.3rem .6rem;
      border-radius:999px;
      border:1px solid #444;
    }

    .main-layout{
      max-width:1200px;
      margin:auto;
      padding:1.5rem 1rem 3rem;
      display:grid;
      grid-template-columns:minmax(0,2.5fr) minmax(260px,1.2fr);
      gap:1.5rem;
    }

    section h2{
      text-align:left;
      font-size:2rem;
      margin-bottom:1rem;
    }
    .menu-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1.2rem;
    }
    .card{
      background:var(--card);
      border-radius:10px;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.5rem;
      min-height:180px;
      box-shadow:0 0 0 1px #222;
    }
    .card h3{font-size:1.2rem}
    .card p{font-size:.9rem;opacity:.9}
    .price{font-weight:700;margin-top:.2rem}
    .card button{
      margin-top:auto;
      padding:.6rem;
      border-radius:6px;
      background:var(--accent);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
    }

    /* SIDE CART */
    #sideCart{
      background:var(--card);
      border-radius:10px;
      padding:1rem;
      display:none;
      flex-direction:column;
      gap:.6rem;
      box-shadow:0 0 0 1px #222;
      position:sticky;
      top:1rem;
      max-height:80vh;
    }
    #sideCart.visible{display:flex;}
    #sideCart h2{
      text-align:left;
      font-size:1.4rem;
      margin-bottom:.2rem;
    }
    .cart-items{
      border-top:1px solid #333;
      border-bottom:1px solid #333;
      padding:.6rem 0;
      display:flex;
      flex-direction:column;
      gap:.4rem;
      overflow-y:auto;
      max-height:40vh;
      font-size:.9rem;
    }
    .cart-item{
      display:grid;
      grid-template-columns:1.2fr auto auto;
      gap:.25rem;
      align-items:center;
    }
    .cart-item-name{font-size:.9rem}
    .qty{
      display:flex;
      align-items:center;
      gap:.25rem;
      justify-content:flex-end;
    }
    .qty button{
      width:22px;
      height:22px;
      border-radius:4px;
      border:1px solid #666;
      background:none;
      color:var(--fg);
      font-weight:700;
      font-size:.8rem;
    }
    .cart-item-price{
      text-align:right;
      font-size:.9rem;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      font-size:.9rem;
      margin-top:.15rem;
    }
    .summary-row strong{font-size:1rem}
    .badge{
      display:inline-block;
      background:#222;
      border-radius:999px;
      padding:.2rem .6rem;
      font-size:.75rem;
      opacity:.9;
    }
    .radio-row{
      display:flex;
      gap:.75rem;
      font-size:.86rem;
      align-items:center;
      margin-top:.3rem;
      flex-wrap:wrap;
    }
    .info-text{
      font-size:.78rem;
      opacity:.85;
      margin-top:.2rem;
    }
    #checkoutBtn{
      margin-top:.7rem;
      width:100%;
      padding:.7rem;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-weight:700;
      font-size:.95rem;
    }
    #clearCartBtn{
      margin-top:.4rem;
      width:100%;
      padding:.5rem;
      border-radius:999px;
      background:#222;
      color:#fff;
      font-size:.8rem;
      border:1px solid #444;
    }

    /* MODAL AUTH */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      visibility:hidden;
      transition:.25s;
      z-index:20;
    }
    .modal.active{opacity:1;visibility:visible}
    .box{
      background:var(--card);
      border-radius:10px;
      padding:1.4rem 1.2rem;
      width:90%;
      max-width:460px;
      max-height:90vh;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:.9rem;
      box-shadow:0 0 0 1px #222;
    }
    .close{
      align-self:flex-end;
      background:none;
      color:var(--fg);
      font-size:1.3rem;
    }
    form{display:grid;gap:.8rem}
    input,select{
      padding:.65rem .7rem;
      border-radius:6px;
      border:1px solid #333;
      background:#222;
      color:var(--fg);
      font-size:.88rem;
    }
    input:focus{outline:1px solid var(--accent);border-color:var(--accent)}
    label{font-size:.8rem;opacity:.9}
    .btn{
      padding:.7rem;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
    }
    #map{
      height:200px;
      border-radius:8px;
      margin-top:.4rem;
      display:none;
    }
    #distText{
      font-size:.8rem;
      margin-top:.15rem;
    }
    #toggleAuth{
      text-align:center;
      font-size:.8rem;
      cursor:pointer;
      opacity:.9;
    }
    small.error{
      color:#ff8080;
      font-size:.75rem;
    }

    /* HORARIO */
    .hours{
      font-size:.8rem;
      opacity:.9;
      margin-bottom:1rem;
    }

    @media(max-width:900px){
      .main-layout{
        grid-template-columns:1fr;
      }
      #sideCart{
        position:static;
        max-height:none;
      }
      header h1{font-size:2rem;}
      #userInfo{display:none;}
    }
  </style>
</head>
<body>
<header>
  <div id="userInfo"></div>
  <h1>MAMMA MAGGI</h1>
  <button id="loginBtn">Ingresar / Registrarse</button>
</header>

<div class="main-layout">
  <!-- MEN√ö -->
  <section>
    <h2>Men√∫</h2>
    <p class="hours">
      üïí Horario de atenci√≥n:<br>
      Mi√©rcoles a s√°bado de <strong>18:00 a 23:00</strong><br>
      Domingo de <strong>12:00 a 16:00</strong>
    </p>
    <div class="menu-grid" id="menuGrid"></div>
  </section>

  <!-- CARRITO LATERAL -->
  <aside id="sideCart">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.4rem;">
      <h2>Tu pedido</h2>
      <span class="badge"><span id="cartCount">0</span> √≠tem(s)</span>
    </div>
    <div class="cart-items" id="cartItems"></div>

    <div>
      <div class="radio-row">
        <label><input type="radio" name="delType" value="pickup" checked> Retiro en local</label>
        <label><input type="radio" name="delType" value="delivery"> Delivery</label>
      </div>
      <p class="info-text">
        Delivery calculado desde <strong>L√©rida con Javiera Carrera, Temuco</strong>.
      </p>
    </div>

    <div class="summary-row">
      <span>Subtotal</span>
      <span>$<span id="subTotal">0</span></span>
    </div>
    <div class="summary-row" id="delRow" style="display:none;">
      <span>Delivery (<span id="kmLabel">0</span> km)</span>
      <span>$<span id="delCost">0</span></span>
    </div>
    <div class="summary-row" style="margin-top:.4rem;">
      <strong>Total</strong>
      <strong>$<span id="total">0</span></strong>
    </div>

    <button id="checkoutBtn">Finalizar por WhatsApp</button>
    <button id="clearCartBtn">Vaciar carrito</button>
    <p class="info-text">
      El pedido se enviar√° por WhatsApp para confirmar disponibilidad y tiempos de entrega üçï
    </p>
  </aside>
</div>

<!-- MODAL AUTH -->
<div class="modal" id="authModal">
  <div class="box">
    <button class="close" id="closeAuth">‚úï</button>
    <h2 id="authTitle">Inicia sesi√≥n</h2>
    <form id="authForm">
      <div>
        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" placeholder="tucorreo@ejemplo.com" required />
      </div>
      <div>
        <label for="pass">Contrase√±a</label>
        <input type="password" id="pass" minlength="6" required />
      </div>
      <div id="extraFields" style="display:none;">
        <div>
          <label for="pass2">Confirmar contrase√±a</label>
          <input type="password" id="pass2" minlength="6" />
        </div>
        <div>
          <label>Nombre</label>
          <input id="name" placeholder="Nombre" />
        </div>
        <div>
          <label>Apellido</label>
          <input id="last" placeholder="Apellido" />
        </div>
        <div>
          <label>Tel√©fono (WhatsApp)</label>
          <input id="phone" placeholder="+569..." />
        </div>
        <div>
          <label>Direcci√≥n (Temuco)</label>
          <input id="addr" placeholder="Calle, n√∫mero, depto..." />
          <button type="button" class="btn" id="geoBtn" style="margin-top:.4rem;">Confirmar direcci√≥n en el mapa</button>
          <p id="distText"></p>
          <div id="map"></div>
        </div>
      </div>
      <small id="authError" class="error"></small>
      <button class="btn" type="submit" id="authSubmit">Entrar</button>
      <p id="toggleAuth">¬øNo tienes cuenta? Reg√≠strate</p>
    </form>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- APP + FIREBASE -->
<script type="module">
  /************  IMPORTS FIREBASE  ************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  /************  CONFIG FIREBASE  ************/
  const firebaseConfig = {
    apiKey: "AIzaSyCd8jNdpZjHJkX-Ft0I6RplS-46vfjbYeU",
    authDomain: "mamma-maggi.firebaseapp.com",
    projectId: "mamma-maggi",
    storageBucket: "mamma-maggi.firebasestorage.app",
    messagingSenderId: "148248596670",
    appId: "1:148248596670:web:91dc5b239ce6b9a9130eef",
    measurementId: "G-L8ZT1KN1YC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /************  CONSTANTES NEGOCIO  ************/
  const PHONE_WHATSAPP = "56949486579";
  const ORIGIN = [-38.731229, -72.626507]; // L√©rida con Javiera Carrera, Temuco
  const RATE_POINTS = 0.001; // 1 punto por cada $1000 aprox

  const MENU = [
    {id:1,name:'Margarita',desc:'Salsa de tomate, mozzarella, albahaca y parmesano.',price:9990},
    {id:2,name:'Pepperoni',desc:'Salsa de tomate, mozzarella y pepperoni.',price:10500},
    {id:3,name:'Not Fugazza',desc:'Salsa de tomate, mozzarella, aceitunas y cebolla.',price:10990},
    {id:4,name:'Napolitana',desc:'Salsa de tomate, mozzarella, jam√≥n, tomate cherry y or√©gano.',price:11500},
    {id:5,name:'Hawaiana',desc:'Salsa de tomate, mozzarella, jam√≥n y pi√±a.',price:11500},
    {id:6,name:'Vegetariana',desc:'Salsa de tomate, mozzarella, aceitunas, champi√±ones, cebolla morada y piment√≥n.',price:11990},
    {id:7,name:'Pesto Cherry',desc:'Salsa de tomate, mozzarella, tomate cherry y pesto.',price:11990},
    {id:8,name:'Pollo BBQ',desc:'Salsa BBQ, mozzarella, pollo, tocino y cebolla morada.',price:12500},
    {id:9,name:'Capi',desc:'Salsa de tomate, mozzarella, pera y queso azul.',price:12500},
    {id:10,name:'Pitu',desc:'Salsa de tomate, mozzarella, jam√≥n serrano, r√∫cula y parmesano.',price:12990},
    {id:11,name:'Bernarda',desc:'Salsa de tomate, mozzarella, queso azul, nueces, miel, ricotta y albahaca.',price:13990},
    {id:12,name:'Bacon No Bacon',desc:'Salsa de tomate, mozzarella, prote√≠na de soja sabor tocino y cebolla.',price:12990},
    {id:13,name:'Mare Verde',desc:'Salsa de tomate, mozzarella, salm√≥n ahumado, r√∫cula y parmesano.',price:15990},
    {id:14,name:'Gamberetti',desc:'Salsa de tomate, mozzarella, camarones salteados en mantequilla de ajo, perejil y lim√≥n.',price:15500},
    {id:15,name:'Sweet Cherry',desc:'Salsa de tomate, mozzarella, tomates cherry confitados, aceitunas y albahaca.',price:13500},
    {id:16,name:'Tiramis√∫',desc:'Postre cl√°sico italiano.',price:4990},
    {id:17,name:'Palitos de ajo',desc:'Palitos con salsa de ajo y parmesano.',price:4500},
    {id:18,name:'Palitos de queso',desc:'Palitos de queso con mozzarella y or√©gano.',price:4990}
  ];

  /************  HELPERS  ************/
  const $ = sel => document.querySelector(sel);
  const formatCLP = n => n.toLocaleString('es-CL');
  const toRad = d => d*Math.PI/180;
  const distanceKm = (lat1,lon1,lat2,lon2)=>{
    const R = 6371;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  };

  /************  ESTADO GLOBAL  ************/
  let cart = {}; // {id: cantidad}
  let deliveryType = 'pickup';
  let currentProfile = null; // datos usuario Firestore
  let currentKm = 0;
  let currentFee = 0;
  let mapInstance = null;
  let mapMarker = null;

  /************  RENDER MEN√ö  ************/
  const menuGrid = $('#menuGrid');
  MENU.forEach(item=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${item.name}</h3>
      <p>${item.desc}</p>
      <span class="price">$${formatCLP(item.price)}</span>
      <button data-id="${item.id}">Agregar</button>
    `;
    menuGrid.appendChild(card);
  });

  menuGrid.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-id]');
    if(!btn) return;
    const id = +btn.dataset.id;
    cart[id] = (cart[id] || 0) + 1;
    updateCart();
  });

  /************  CARRITO  ************/
  const sideCart = $('#sideCart');
  const cartItemsC = $('#cartItems');
  const subTotalEl = $('#subTotal');
  const delCostEl = $('#delCost');
  const totalEl = $('#total');
  const cartCountEl = $('#cartCount');
  const delRow = $('#delRow');
  const kmLabel = $('#kmLabel');

  function updateCart(){
    const ids = Object.keys(cart);
    const hasItems = ids.length>0;
    sideCart.classList.toggle('visible', hasItems);

    cartItemsC.innerHTML = '';
    let sub = 0;
    ids.forEach(id=>{
      const item = MENU.find(m=>m.id==id);
      const q = cart[id];
      const line = document.createElement('div');
      line.className = 'cart-item';
      line.innerHTML = `
        <span class="cart-item-name">${item.name}</span>
        <div class="qty" data-id="${id}">
          <button class="dec">-</button>
          <span>${q}</span>
          <button class="inc">+</button>
        </div>
        <span class="cart-item-price">$${formatCLP(item.price*q)}</span>
      `;
      cartItemsC.appendChild(line);
      sub += item.price*q;
    });
    if(!hasItems){
      cartItemsC.innerHTML = '<p style="font-size:.85rem;opacity:.9;">Tu carrito est√° vac√≠o. Agrega algo del men√∫ üçï</p>';
    }
    cartCountEl.textContent = ids.reduce((a,b)=>a+cart[b],0);
    subTotalEl.textContent = formatCLP(sub);
    recalcTotals();
  }

  cartItemsC.addEventListener('click', e=>{
    const qtyBox = e.target.closest('.qty');
    if(!qtyBox) return;
    const id = +qtyBox.dataset.id;
    if(e.target.classList.contains('inc')){
      cart[id]++;
    }else if(e.target.classList.contains('dec')){
      cart[id] = Math.max(0, cart[id]-1);
      if(cart[id]===0) delete cart[id];
    }
    updateCart();
  });

  document.querySelectorAll('input[name="delType"]').forEach(r=>{
    r.addEventListener('change', e=>{
      deliveryType = e.target.value;
      recalcTotals();
    });
  });

  function recalcTotals(){
    const sub = parseInt(subTotalEl.textContent.replace(/\./g,'')) || 0;
    let fee = 0;
    let km = 0;
    if(deliveryType==='delivery' && currentProfile && currentProfile.km){
      fee = Math.ceil(currentProfile.km)*1000;
      km = currentProfile.km.toFixed(1);
    }
    if(deliveryType==='delivery' && (!currentProfile || !currentProfile.km)){
      km = 0;
      fee = 0;
    }
    delRow.style.display = (deliveryType==='delivery' && fee>0) ? 'flex' : 'none';
    delCostEl.textContent = formatCLP(fee);
    kmLabel.textContent = km;
    const total = sub + fee;
    totalEl.textContent = formatCLP(total);
  }

  $('#clearCartBtn').addEventListener('click', ()=>{
    cart = {};
    updateCart();
  });

  /************  AUTH MODAL  ************/
  const authModal = $('#authModal');
  const loginBtn = $('#loginBtn');
  const closeAuth = $('#closeAuth');
  const toggleAuth = $('#toggleAuth');
  const authTitle = $('#authTitle');
  const extraFields = $('#extraFields');
  const authForm = $('#authForm');
  const authError = $('#authError');

  let loginMode = true; // true = login, false = registro

  loginBtn.addEventListener('click', ()=>{
    authModal.classList.add('active');
  });
  closeAuth.addEventListener('click', ()=>authModal.classList.remove('active'));

  toggleAuth.addEventListener('click', ()=>{
    loginMode = !loginMode;
    if(loginMode){
      authTitle.textContent = 'Inicia sesi√≥n';
      $('#authSubmit').textContent = 'Entrar';
      extraFields.style.display = 'none';
      toggleAuth.textContent = '¬øNo tienes cuenta? Reg√≠strate';
    }else{
      authTitle.textContent = 'Crear cuenta';
      $('#authSubmit').textContent = 'Registrarme';
      extraFields.style.display = 'block';
      toggleAuth.textContent = '¬øYa tienes cuenta? Inicia sesi√≥n';
    }
    authError.textContent = '';
  });

  /************  MAPA Y DIRECCI√ìN  ************/
  const geoBtn = $('#geoBtn');
  const distText = $('#distText');
  const mapDiv = $('#map');

  geoBtn.addEventListener('click', async()=>{
    const addr = $('#addr').value.trim();
    if(!addr){
      alert('Escribe una direcci√≥n primero');
      return;
    }
    try{
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr+', Temuco, Chile')}`;
      const res = await fetch(url, {headers:{'Accept-Language':'es'}});
      const data = await res.json();
      if(!data[0]){
        alert('No se encontr√≥ la direcci√≥n, prueba con otro detalle.');
        return;
      }
      const {lat, lon, display_name} = data[0];
      const km = distanceKm(ORIGIN[0], ORIGIN[1], +lat, +lon);
      const fee = Math.ceil(km)*1000;
      currentKm = km;
      currentFee = fee;
      distText.textContent = `${km.toFixed(1)} km ‚Ä¢ Delivery estimado $${formatCLP(fee)} (${display_name})`;
      mapDiv.style.display = 'block';

      if(!mapInstance){
        mapInstance = L.map('map').setView([lat,lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
          attribution:'¬© OpenStreetMap'
        }).addTo(mapInstance);
      }else{
        mapInstance.setView([lat,lon], 14);
      }
      if(mapMarker){
        mapInstance.removeLayer(mapMarker);
      }
      mapMarker = L.marker([lat,lon]).addTo(mapInstance);

    }catch(err){
      console.error(err);
      alert('Error al buscar direcci√≥n');
    }
  });

  /************  SUBMIT AUTH  ************/
  authForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    authError.textContent = '';

    const email = $('#email').value.trim().toLowerCase();
    const pass = $('#pass').value;

    if(loginMode){
      // LOGIN
      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await loadProfile(cred.user);
        authModal.classList.remove('active');
      }catch(err){
        console.error(err);
        authError.textContent = 'No se pudo iniciar sesi√≥n. Revisa tus datos.';
      }
    }else{
      // REGISTRO
      const pass2 = $('#pass2').value;
      if(pass!==pass2){
        authError.textContent = 'Las contrase√±as no coinciden.';
        return;
      }
      const nombre = $('#name').value.trim();
      const apellido = $('#last').value.trim();
      const phone = $('#phone').value.trim();
      const address = $('#addr').value.trim();

      if(!nombre || !apellido || !phone || !address){
        authError.textContent = 'Completa todos los datos de registro.';
        return;
      }

      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        const profileDoc = {
          email,
          nombre,
          apellido,
          phone,
          address,
          km: currentKm || 0,
          fee: currentFee || 0,
          points: 0,
          createdAt: serverTimestamp()
        };

        await setDoc(doc(db,'users',uid), profileDoc);
        currentProfile = {uid,...profileDoc};
        updateUserUI();
        authModal.classList.remove('active');
        recalcTotals();
      }catch(err){
        console.error(err);
        authError.textContent = 'No se pudo registrar. Tal vez el correo ya existe.';
      }
    }
  });

  async function loadProfile(user){
    const ref = doc(db,'users',user.uid);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data();
      currentProfile = {uid:user.uid, ...data};
      currentKm = data.km || 0;
      currentFee = data.fee || 0;
    }else{
      // si no existe perfil, crear b√°sico
      const basic = {
        email:user.email,
        nombre:'Cliente',
        apellido:'',
        phone:'',
        address:'',
        km:0,
        fee:0,
        points:0,
        createdAt:serverTimestamp()
      };
      await setDoc(ref,basic);
      currentProfile = {uid:user.uid,...basic};
    }
    updateUserUI();
    recalcTotals();
  }

  function updateUserUI(){
    const userInfo = $('#userInfo');
    if(currentProfile){
      userInfo.textContent = `Hola, ${currentProfile.nombre} (${currentProfile.email})`;
      loginBtn.textContent = 'Cerrar sesi√≥n';
    }else{
      userInfo.textContent = '';
      loginBtn.textContent = 'Ingresar / Registrarse';
    }
  }

  loginBtn.addEventListener('click', async ()=>{
    if(currentProfile){
      // si est√° logueado, este mismo bot√≥n sirve para cerrar sesi√≥n
      if(confirm('¬øCerrar sesi√≥n?')){
        await signOut(auth);
        currentProfile=null;
        updateUserUI();
      }
    }else{
      authModal.classList.add('active');
    }
  });

  onAuthStateChanged(auth, user=>{
    if(user){
      loadProfile(user);
    }else{
      currentProfile=null;
      updateUserUI();
    }
  });

  /************  FINALIZAR PEDIDO  ************/
  $('#checkoutBtn').addEventListener('click', async ()=>{
    const ids = Object.keys(cart);
    if(ids.length===0){
      alert('Tu carrito est√° vac√≠o.');
      return;
    }
    if(!currentProfile){
      alert('Debes iniciar sesi√≥n o registrarte antes de finalizar el pedido.');
      authModal.classList.add('active');
      return;
    }
    if(deliveryType==='delivery' && (!currentProfile.address || !currentProfile.km)){
      alert('Para delivery, confirma tu direcci√≥n en el registro.');
      authModal.classList.add('active');
      return;
    }

    const sub = parseInt(subTotalEl.textContent.replace(/\./g,''))||0;
    const fee = (deliveryType==='delivery' && currentProfile.km) ? Math.ceil(currentProfile.km)*1000 : 0;
    const total = sub+fee;

    // armar items
    const items = ids.map(id=>{
      const item = MENU.find(m=>m.id==id);
      return {
        id:item.id,
        name:item.name,
        qty:cart[id],
        unitPrice:item.price,
        lineTotal:item.price*cart[id]
      };
    });

    // puntos ganados
    const earnedPts = Math.floor(total*RATE_POINTS);

    try{
      // guardar pedido en Firestore
      await addDoc(collection(db,'orders'),{
        userUid:currentProfile.uid,
        userEmail:currentProfile.email,
        items,
        subtotal:sub,
        deliveryFee:fee,
        total,
        deliveryType,
        address:currentProfile.address,
        phone:currentProfile.phone,
        km:currentProfile.km || 0,
        createdAt:serverTimestamp(),
        earnedPoints:earnedPts
      });

      // actualizar puntos usuario
      const newPoints = (currentProfile.points||0)+earnedPts;
      await setDoc(doc(db,'users',currentProfile.uid),{
        ...currentProfile,
        points:newPoints
      });
      currentProfile.points = newPoints;

    }catch(err){
      console.error(err);
      alert('Hubo un problema guardando el pedido, pero intentaremos enviar el WhatsApp igual.');
    }

    // Mensaje WhatsApp
    let msg = `Hola Mamma Maggi!%0AQuiero hacer este pedido:%0A`;
    items.forEach(it=>{
      msg += `${it.qty} x ${it.name} ($${formatCLP(it.unitPrice)})%0A`;
    });
    msg += `%0ASubtotal: $${formatCLP(sub)}`;
    if(fee>0){
      msg += `%0ADelivery: $${formatCLP(fee)}`;
    }
    msg += `%0ATOTAL: $${formatCLP(total)}%0A`;
    msg += `%0ADatos cliente:%0A${currentProfile.nombre} ${currentProfile.apellido}%0A`;
    msg += `${currentProfile.address}%0A`;
    msg += `Tel: ${currentProfile.phone}%0A`;
    msg += `%0ATipo: ${deliveryType==='delivery'?'Delivery':'Retiro en local'}`;

    const url = `https://wa.me/${PHONE_WHATSAPP}?text=${msg}`;
    window.open(url, '_blank');
  });

  // inicializar carrito vac√≠o visualmente
  updateCart();

</script>
</body>
</html>



