<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mammaâ€¯Maggi | Pedidos Online</title>
  <!-- Google Fonts & Leaflet -->
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg:#111;--fg:#fff;--accent:#e63946;--card:#1a1a1a}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;line-height:1.5}
    a{color:var(--accent)}button{font-family:inherit;cursor:pointer;border:none}
    h1,h2,h3{font-family:'Staatliches',cursive;font-weight:400}
    header{display:flex;justify-content:center;align-items:center;gap:.5rem;padding:1.2rem 1rem;position:relative;text-align:center}
    header h1{font-size:2.3rem;letter-spacing:2px}
    #userInfo{font-size:.8rem;opacity:.8}
    #cartBtn{position:absolute;right:1rem;top:1.1rem;width:42px;height:42px;border:2px solid var(--fg);border-radius:50%;background:none;color:var(--fg);display:flex;align-items:center;justify-content:center}
    #cartBtn span{font-size:.8rem}
    #loginIcon{position:absolute;left:1rem;top:1.1rem;background:none;color:var(--fg);font-size:1.2rem}
    section{max-width:960px;margin:auto;padding:2rem 1rem}
    section h2{text-align:center;font-size:2rem;margin-bottom:1.3rem}
    form{display:grid;gap:1rem;max-width:480px;margin:auto}
    input,select{padding:.7rem;border-radius:4px;border:1px solid #333;background:#222;color:var(--fg)}
    label{font-size:.85rem;opacity:.8}
    .btn{padding:.8rem;border-radius:4px;background:var(--accent);color:#fff;font-weight:700;transition:opacity .2s}
    .btn:hover{opacity:.8}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity .3s}
    .modal.active{opacity:1;visibility:visible}
    .box{background:var(--card);border-radius:8px;padding:1.4rem;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;gap:1rem}
    .close{align-self:flex-end;background:none;color:var(--fg);font-size:1.4rem;cursor:pointer}
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem}
    .card{background:var(--card);border-radius:8px;padding:1rem;display:flex;flex-direction:column;gap:.6rem;min-height:200px}
    .price{font-weight:700}
    .cart-item{display:flex;justify-content:space-between;align-items:center;gap:.3rem}
    .qty{display:flex;align-items:center;gap:.4rem}
    .qty button{width:24px;height:24px;border:1px solid var(--fg);background:none;color:var(--fg);border-radius:4px;font-weight:700}
    .summary{text-align:right;font-size:1.05rem;font-weight:700}
    #map{height:220px;border-radius:6px;margin-top:.5rem;display:none}
  </style>
</head>
<body>
  <header>
    <button id="loginIcon" title="Ingresar / Registrarse">ðŸ‘¤</button>
    <h1>MAMMA MAGGI</h1>
    <div id="userInfo"></div>
    <button id="cartBtn">ðŸ›’ <span id="cartCount">0</span></button>
  </header>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="box">
      <span class="close" id="closeAuth">âœ•</span>
      <h2 id="authTitle">Inicia SesiÃ³n</h2>
      <form id="authForm">
        <input type="email" id="emailAuth" placeholder="Correo" required />
        <input type="password" id="passAuth" placeholder="ContraseÃ±a" required />
        <div id="extraFields" style="display:none">
          <input type="text" id="firstName" placeholder="Nombre" />
          <input type="text" id="lastName" placeholder="Apellido" />
          <input type="tel" id="phone" placeholder="TelÃ©fono" />
          <input type="text" id="address" placeholder="DirecciÃ³n (Temuco)" />
          <button type="button" class="btn" id="calcDist">Confirmar direcciÃ³n</button>
          <p id="distInfo" style="text-align:center"></p>
          <div id="map"></div>
        </div>
        <button class="btn" type="submit" id="authBtn">Entrar</button>
        <p id="toggleAuth" style="text-align:center;cursor:pointer;margin-top:.6rem">Â¿No tienes cuenta? RegÃ­strate</p>
      </form>
    </div>
  </div>

  <!-- MENU -->
  <section id="menuSection">
    <h2>Nuestro MenÃº</h2>
    <div class="menu-grid" id="menuGrid"></div>
  </section>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal">
    <div class="box">
      <span class="close" id="closeCart">âœ•</span>
      <h2>Tu Pedido</h2>
      <div id="cartItems"></div>
      <div id="deliveryBox">
        <label><input type="radio" name="deliveryType" value="pickup" checked /> Retiro en local</label><br />
        <label><input type="radio" name="deliveryType" value="delivery" /> Delivery</label>
      </div>
      <div>
        <label>CÃ³digo de descuento</label>
        <div style="display:flex;gap:.5rem;margin-top:.3rem">
          <input type="text" id="coupon" style="flex:1" placeholder="Ej: MAGGI10" />
          <button class="btn" id="applyCoupon" style="padding:.6rem .8rem">Aplicar</button>
        </div>
        <small id="couponMsg"></small>
      </div>
      <div id="pointsBox" style="display:none">
        <p>Tienes <span id="pointsAvail">0</span> puntos.</p>
        <label><input type="checkbox" id="redeemPts" /> Usar puntos (1â€¯ptâ€¯=â€¯$100)</label>
      </div>
      <p class="summary">Subtotal: $<span id="subtotal">0</span></p>
      <p class="summary" id="deliveryCostRow" style="display:none">Delivery (<span id="kmLabel">0</span>Â km): $<span id="deliveryCost">0</span></p>
      <p class="summary" id="discountRow" style="display:none">Descuento: â€‘$<span id="discountVal">0</span></p>
      <p class="summary" id="redeemRow" style="display:none">â€‘Puntos: â€‘$<span id="redeemVal">0</span></p>
      <p class="summary">Total: $<span id="cartTotal">0</span></p>
      <a class="btn" id="checkoutBtn" href="#">Finalizar por WhatsApp</a>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const menuItems=[{id:1,name:'Margarita',desc:'Salsa de tomate, mozzarella, albahaca y parmesano.',price:8990},{id:2,name:'Pepperoni',desc:'Salsa de tomate, mozzarella y pepperoni.',price:9500},{id:3,name:'Not Fugazza',desc:'Salsa de tomate, mozzarella, aceitunas y cebolla.',price:9990},{id:4,name:'Napolitana',desc:'Salsa de tomate, mozzarella, jamÃ³n, tomate cherry y orÃ©gano.',price:10500},{id:5,name:'Hawaiana',desc:'Salsa de tomate, mozzarella, jamÃ³n y piÃ±a.',price:10500},{id:6,name:'Vegetariana',desc:'Salsa de tomate, mozzarella, aceitunas, champiÃ±ones, cebolla morada y pimentÃ³n.',price:10990},{id:7,name:'Pesto Cherry',desc:'Salsa de tomate, mozzarella, tomate cherry y pesto.',price:10990},{id:8,name:'Pollo BBQ',desc:'Salsa BBQ, mozzarella, pollo, tocino y cebolla morada.',price:11500},{id:9,name:'Capi',desc:'Salsa de tomate, mozzarella, pera y queso azul.',price:11500},{id:10,name:'Pitu',desc:'Salsa de tomate, mozzarella, jamÃ³n serrano, rÃºcula y parmesano.',price:11990},{id:11,name:'Palitos de Ajo',desc:'Palitos con salsa de ajo y parmesano.',price:4500},{id:12,name:'Palitos de Queso',desc:'Palitos de queso con mozzarella y orÃ©gano.',price:4990}];
    const ORIGIN=[-38.7393,-72.6080];
    const discountCodes={MAGGI10:0.1};
    const POINT_RATE=0.001,POINT_VALUE=100;
    const WHATSAPP_PHONE='56949486579';

    const cart={},users=JSON.parse(localStorage.getItem('users')||'{}');
    let currentUser=null,deliveryType='pickup',appliedDiscount=0,discountCode=null,redeemPoints=false;

    const $=q=>document.querySelector(q);
    const format=n=>n.toLocaleString('es-CL');
    const toRad=d=>d*Math.PI/180;
    const distKm=(lat1,lon1,lat2,lon2)=>{const R=6371,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));};
    const feeByKm=km=>km<=3?0:km<=8?1000:km<=15?2000:4000;

    const grid=$('#menuGrid');
    menuItems.forEach(itm=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<h3>${itm.name}</h3><p>${itm.desc}</p><span class='price'>$${format(itm.price)}</span><button class='btn' data-id='${itm.id}'>Agregar</button>`;grid.appendChild(card);});
    grid.onclick=e=>{if(e.target.matches('button[data-id]')){const id=+e.target.dataset.id;cart[id]=(cart[id]||0)+1;updateCartCount();}};
    const updateCartCount=()=>$('#cartCount').textContent=Object.values(cart).reduce((a,b)=>a+b,0);

    const authModal=$('#authModal');
    $('#loginIcon').onclick=()=>{authModal.classList.add('active');$('#emailAuth').focus();};
    $('#closeAuth').onclick=()=>authModal.classList.remove('active');

    let isLogin=true;
    $('#toggleAuth').onclick=()=>{isLogin=!isLogin;$('#authTitle').textContent=isLogin?'Inicia SesiÃ³n':'Crea tu Cuenta';$('#authBtn').textContent=isLogin?'Entrar':'Registrar';$('#extraFields').style.display=isLogin?'none':'block';};

    $('#calcDist').onclick=async()=>{
      const addr=$('#address').value.trim();if(!addr)return alert('Ingresa direcciÃ³n');
      try{const data=await(fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr+', Temuco, Chile')}`)).then(r=>r.json());if(!data[0])throw 0;const {lat,lon}=data[0];const km=Math.round(distKm(ORIGIN[0],ORIGIN[1],+lat,+lon)*10)/10;const fee=feeByKm(km);
        $('#distInfo').textContent=`Dist: ${km} km â€¢ Delivery $${format(fee)}`;$('#map').style.display='block'; if(!window._map){window._map=L.map('map').setView([lat,lon],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(_map);} _map.setView([lat,lon],13); if(window._marker)_map.removeLayer(_marker); _marker=L.marker([lat,lon]).addTo(_map);
        currentUser={...currentUser,lat:+lat,lng:+lon,km,deliveryFee:fee,address:addr};
      }catch{alert('No se pudo geocodificar');}
    };

    $('#authForm').onsubmit=e=>{
      e.preventDefault();const email=$('#emailAuth').value.trim().toLowerCase(),pass=$('#passAuth').value;
      if(isLogin){if(!users[email]||users[email].pass!==pass)return alert('Credenciales incorrectas');currentUser={...users[email]};afterLogin();}
      else{if(!currentUser||!currentUser.km)return alert('Confirma direcciÃ³n');currentUser={...currentUser,email,pass,nombre:$('#firstName').value.trim(),apellido:$('#lastName').value.trim(),phone:$('#phone').value.trim(),points:0};users[email]={...currentUser};localStorage.setItem('users',JSON.stringify(users));afterLogin();}
    };
    function afterLogin(){authModal.classList.remove('active');$('#userInfo').textContent=`Hola, ${currentUser.nombre} (${currentUser.points} pts)`;$('#pointsAvail').textContent=currentUser.points;$('#pointsBox').style.display='block';}

    /* CART */
    const cartModal=$('#cartModal');
    $('#cartBtn').onclick=()=>{renderCart();cartModal.classList.add('active');};
    $('#closeCart').onclick=()=>cartModal.classList.remove('
